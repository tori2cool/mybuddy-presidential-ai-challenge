# Keycloak web setup (MyBuddy)

This app uses **Authorization Code + PKCE** via `expo-auth-session`.

## Web login flow implementation notes

- On Expo SDK 54 with `expo-auth-session@~7`, **`AuthSession.startAsync` is not available**.
- Web login uses `AuthRequest.promptAsync(...)` when possible, and falls back to `expo-web-browser` `openAuthSessionAsync(authUrl, redirectUri)`.
- The app parses the browser return URL to extract the `code`.

## Redirect URIs

The redirect URI used by the app is platform-specific:

- **Web**: `${window.location.origin}/auth/callback`
  - Example (prod): `https://mybuddy.suknet.org/auth/callback`
  - Example (local): `http://localhost:19006/auth/callback`

- **Native** (iOS/Android): `mybuddy://...` (generated by `makeRedirectUri({ scheme: 'mybuddy', useProxy: true })` during development)

### Keycloak client config

In Keycloak (Client â†’ Settings):

- **Valid Redirect URIs** must include the web callback URL(s), e.g.
  - `https://mybuddy.suknet.org/auth/callback`
  - `http://localhost:19006/auth/callback`

- **Web Origins** must include the web origin(s), e.g.
  - `https://mybuddy.suknet.org`
  - `http://localhost:19006`

If these values do not match exactly, login may fail on web with `promptAsync` returning `{ type: 'dismiss' }` or the redirect being blocked.

## Notes

- On web we **do not** use the Expo proxy.
- If a browser blocks popups, the auth prompt may be dismissed/cancelled.
